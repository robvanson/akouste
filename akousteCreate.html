<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<link rel="apple-touch-icon" sizes="57x57" href="favicon/favicon-57x57.png" type="image/png" />
<link rel="apple-touch-icon" sizes="60x60" href="favicon/favicon-60x60.png" type="image/png" />
<link rel="apple-touch-icon" sizes="72x72" href="favicon/favicon-72x72.png" type="image/png" />
<link rel="apple-touch-icon" sizes="114x114" href="favicon/favicon-114x114.png" type="image/png" />
<link rel="apple-touch-icon" sizes="120x120" href="favicon/favicon-120x120.png" type="image/png" />
<link rel="apple-touch-icon" sizes="144x144" href="favicon/favicon-144x144.png" type="image/png" />
<link rel="apple-touch-icon" sizes="152x152" href="favicon/favicon-152x152.png" type="image/png" />
<link rel="apple-touch-icon" sizes="180x180" href="favicon/favicon-180x180.png" type="image/png" />
<link rel="icon" sizes="16x16" href="favicon/favicon-16x16.png" type="image/png" />
<link rel="icon" sizes="32x32" href="favicon/favicon-32x32.png" type="image/png" />
<link rel="icon" sizes="96x96" href="favicon/favicon-96x96.png" type="image/png" />
<link rel="icon" sizes="192x192" href="favicon/favicon-192x192.png" type="image/png" />
<link rel="icon" sizes="512x512" href="favicon/favicon-512x512.png" type="image/png" />
<link rel="manifest" href="favicon/manifest.json" />
<meta name="theme-color" content="#FFFFFF" />
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="favicon/favicon-512x512.png" />

<script src="./markdown-it.min.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js" referrerpolicy="no-referrer" onerror="if(typeof window.markdownit == 'undefined')alert('No HTML! Cannot load '+this.src);"></script>
<script id='mardownRead' type="text/javascript" src="./akousteInitPageMD.js"></script>
<script type="text/javascript" >
function loadMarkdown(fileName) {
  (function(d, script) {
      script = d.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.onload = function(){
		initializeMarkdown();
		markdown2HTML ();
      };
    script.src = fileName;
    d.getElementsByTagName('head')[0].appendChild(script);
  }(document));

}
</script>
<script type="text/javascript" >
	// Doesn't work due to blocking of Cross origin requests of local files
	async function getMarkdown(file) {
	  let response = await fetch(file);
	  let data = await response.text();
	  initialMarkdown = data;
	  document.getElementById("markdownText").value = initialMarkdown;
	  currentMarkdown = initialMarkdown;
	  markdownStack.push(currentMarkdown);
	};
	if(typeof initialMarkdown != "string" || initialMarkdown == null){
		initialMarkdown = ` 
[//comment]: # "Use the 'Start of coverpage' - 'End of coverpage' comments to insert a coverpage"
[//coverpage]: # "Start of coverpage"

<center>

# The Cover Page

</center>

A cover page is optional, but often useful. A cover page is generally used to explain the aim and procedure of the experiment, and how to save and convey the results after completion of the experiment.

It is adviseable to include a [[[ sound sample|<https://upload.wikimedia.org/wikipedia/commons/2/2d/Nl-aardhommel.ogg>{font-size:1em}]]] to check the sound quality and level. 

[//coverpage]: # "End of coverpage"

<center>

# Title of this page

### A table setup to position three *audio play buttons* representing columns *A*, *B* and *X* in the stimulus table. 

|     |               |              |              |     |
| -: | -------: | :------: | :------- | :- |
|     | [[[A]]]    |             | [[[B]]]   |     |
|     |               | [[[X]]]  |              |     |

The tripple &#123;&#123;&#123;**name|style**&#125;&#125;&#125;-bracket pairs insert text. A simple **name** is interpreted as the name of a Stimulus table column and is replaced with the current content of that stimulus value. If **name** has the form **&lt;URL&gt;**, the page behind that URL is loaded. If **name** has the form of **!parameter!** (parameter enclosed between two !-characters), the value of that variable is subtituted, as is done below.

<center>

[//comment]: // "Start of No Change"

## {{{!answerstogo!|font-weight:bold}}} answers to go

[//comment]: // "End of No Change"

</center>

All elements, eg, radio and audio buttons, sliders are positioned in tables. 
Tables are defined using the |-bar character together with the :--: separator. See this [tutorial](https://htmlmarkdown.com/syntax/markdown-tables/). The full syntax of the markdown used is described [here](https://markdown-it.github.io/). You can freely mix in HTML and JavaScript, but you need to leave empty lines between HTML+JavaScript and markdown.

Audio buttons are enclosed in tripple &#91;&#91;&#91;&#93;&#93;&#93;-brackets with content inside. The format is &#91;&#91;&#91;**text|name{style}**&#93;&#93;&#93;, 
with the displayed **text**, a "**|**", the **name** of a stimulus (column) and a CSS **style** of the button, eg, font-size. When the **name** is enclosed in &lt;&gt;-brackets, eg, &lt;**url-or-local-file-path**&gt;, this is used as a fixed sound. Everything but the name is optional.

Here you can put the text which tells the subjects what they are supposed to do. You can add or remove &lt;center&gt; &lt;/center&gt; pairs if you want to change the text alignment. The [&lt;div&gt; tag](https://elementor.com/blog/what-is-div-in-html/) gives many more layout options.


---------------------------

<center>


### Question text. Which sound is most like the X sound? The double ()-brackets are converted into radio buttons
 |     |        |       |    | 
 | -: | :--: | :--: | :- |
 |     | (()) | (()) |    | 
 |     |  A    |  B  |    | 


### Question text. How well does Sound X resemble the chosen A or B sound?
|                 |        |        |        |        |        |                     |
| ----------: | :---: | :---: | :---: | :---: | :---: | :------------- |
| Not at all |  (()) | (()) | (())  | (())  | (()) |  Very Much  |
|           1    |        |        |   3   |        |       |     5              |

### More question can be added, with different numbers of options. Also, audio buttons can be added pointing to fixed URLs/files
|                 |        |        |         |        |        |        |         |                     |
| ----------: | :---: | :---: | :---:  | :---: | :---: | :---: | :---: | :------------- |
| Not at all |  (()) | (()) | (())   | (()) | (())  | (())  |  (())  |  Very Much |
| [[[example\\|<https://upload.wikimedia.org/wikipedia/commons/e/e7/Fr-bordure.ogg>{font-size:15px}]]]   |        |        |         |   [[[equal\\|<https://upload.wikimedia.org/wikipedia/commons/d/db/En-uk-illustrate.ogg>{font-size:15px}]]]  |        |        |           |   [[[example\\|<https://upload.wikimedia.org/wikipedia/commons/6/62/De-Aluminium.ogg>{font-size:15px}]]]   |

### Other response options can be added. A VAS slider is indicated by &gt;&gt;----------&lt;&lt; (&gt;&gt;&lt;&lt; separated by 10 or more dashes)

|                   |                                                 |                      |
| ------------: | :----------------------------------: | :-------------- |
| Not at all   |  >>---------------------------<<  |   Very Much  |
|           0      |                         50                      |         100          |


### Stimulus text labels can be added with triple {**name|style**}-brackets. Which language are you most familiar with?

|     |                     |                      |                      |      |
| -: | :----------: | :-----------: | :-----------: | :- |
|     |         (())      |         (())        |        (())         |     |
|     | {{{LangA}}} |  {{{LangB}}}  |  {{{LangX}}}  |    |

### And you can also request text input from the user with a &lt;&lt;| text {style} |&gt;&gt; construct

What do you think?  <<|  your opinion here {width:5cm;color:gray;text-align:center} |>>


</center>

---------------------------

[//comment]: # "These are internal parameters for the experiment and visible texts not in this Markdown"
[//comment]: # "----------"
[//parameter]: # "ExperimentAcronym:name_without_spaces"
[//parameter]: # "audioBaseURL:./Stimuli/"
[//parameter]: # "PracticeItems:4"
[//parameter]: # "ShuffleStimuli:true"
[//parameter]: # "RandomizeAB:false"
[//buttontext]: # "NextText:Next"
[//buttontext]: # "NextAlertText:Please listen to the recordings and answer the questions first"
[//buttontext]: # "ReadyText:Ready"
[//buttontext]: # "PlayText:Play"
[//buttontext]: # "RestartPageText:Restart"
[//buttontext]: # "SaveButtonText:Save Results"
[//buttontext]: # "SaveText:Please click XXSaveButtonTextXX and store the file"
[//tooltiptext]: # "ToolTipPlay:Play sound"
[//tooltiptext]: # "ToolTipNext:Go to next item"
[//tooltiptext]: # "ToolTipReady:Ready, please save results"
[//tooltiptext]: # "ToolTipRestart:Start a new experiment session"
[//tooltiptext]: # "ToolTipSave:Save the answer to a file"
[//comment]: # "----------"
[//comment]: # "These are stimuli for this experiment"
[//comment]: # "----------"
[//stimulus0]: # "A,B,X,LangA,LangB,LangX"
[//stimulus1]: # "https://upload.wikimedia.org/wikipedia/commons/6/62/De-Aluminium.ogg,https://upload.wikimedia.org/wikipedia/commons/e/e7/Fr-bordure.ogg,https://upload.wikimedia.org/wikipedia/commons/d/db/En-uk-illustrate.ogg,De,Fr,En"
[//stimulus1]: # "https://upload.wikimedia.org/wikipedia/commons/2/2d/Nl-aardhommel.ogg,https://upload.wikimedia.org/wikipedia/commons/8/8e/Or-ଅନୁଶୀଳନ.oga,https://upload.wikimedia.org/wikipedia/commons/d/da/L1188694-F1.oga,Nl,Or,Ar"
[//comment]: # "----------"
`
}

</script>

<script type="text/javascript" src="./akousteHTMLtemplate.js"></script>
<script type="text/javascript">
	// Extract the styles from the preamble
		var experimentStyles = preamble.replace(/^(.|\n|\r)*<style/i, "<style");
		experimentStyles = experimentStyles.replace(/<\/style>(?!(.|\n|\r)*<\/style>)(.|\n|\r)*/ig, "</style>");
	
		function readMDFromFile (elementId) {
			mdFileText = "";
			var file = document.getElementById(elementId).files[0];
			if (file && file.name.match(/\.(md|markdown)$/i)) {
			    var reader = new FileReader();
			    reader.readAsText(file, "UTF-8");
			    reader.onload = function (evt) {						
					mdFileText = evt.target.result;
					initialMarkdown = mdFileText;
					document.getElementById('markdownText').value = initialMarkdown;
					initializeMarkdown();
					markdown2HTML ();
					document.getElementById('MarkdownFileUpload').value = "";
			    };
			    reader.onerror = function (evt) {
			        alert("error reading file");
			    };
			} else if(file) {
				alert("Wrong file type: "+file.name);
			} else {
				alert("Select a file first");
			};
			
			// Clear body.style
			bodyStyleText = "";
			
			return mdFileText;
		};
		
		var stimulusTable = [["A","B","X"], ["https://upload.wikimedia.org/wikipedia/commons/6/62/De-Aluminium.ogg", "https://upload.wikimedia.org/wikipedia/commons/e/e7/Fr-bordure.ogg", "https://upload.wikimedia.org/wikipedia/commons/d/db/En-uk-illustrate.ogg"]];
		function setStimulusTableValue (x) {
			if(x == undefined || x.length <= 0)return false;
			stimulusTable = x;
			stimulusTableJSON = "\` \n" + JSON.stringify(stimulusTable) + "\n\`"
			stimulusTableJSON = stimulusTableJSON.replace(/\],\[/g, "],\n[");
			document.getElementById('SaveStimulusTable').style.visibility = 'visible';
			document.getElementById('SaveStimulusTable').style.backgroundColor = 'MediumAquaMarine';
			parameters2Markdown();
		};
		
		function readTableFromFile (elementId) {
			tableJSON = "";
			var tableListJSON = new Array();
			var file = document.getElementById(elementId).files[0];
			if (file && file.name.match(/\.(csv|tsv|txt|text)$/)) {
				var tableList = [];
			    var reader = new FileReader();
			    reader.readAsText(file, "UTF-8");
			    reader.onload = function (evt) {						
					var separator = document.getElementById('Separator').value;
					if(separator == "tab"){
						separator = /\t/;
					} else if(separator == "semicolon") {
						separator = /;/;
					} else if(separator == "comma") {
						separator = /,/;
					} else if(evt.target.result.match(/\t/)){
						separator = /\t/;
					} else if (evt.target.result.match(/;/)){
						separator = /;/;
					} else if (evt.target.result.match(/,/)){
						separator = /,/;
					} else {
						separator = /\t/;
					};
					var textRead = evt.target.result.split(/\n/);
					if(textRead.length <= 1) {
						alert("Not a valid CSV table: "+file);
						return void(0);
					};
					for(var i in  textRead) {
						// Silly Javascript hack to remove CR \r
						row = textRead[i].replace(/\r/g,"");
						if(row.search(/\w/) >= 0){
							tableList.push(row.split(separator));
						};
					};
					if(tableList.length <= 1) {
						alert("Not a valid CSV table: "+file.name);
						return void(0);
					};

			        // One single list
					var x = [];
					x.push(tableList[0]);
					x.push(tableList.slice(1));
					setStimulusTableValue(x);
					
					// Ready, clear file name
					document.getElementById('StimulusFileUpload').value = "";
				};
			    reader.onerror = function (evt) {
			        document.getElementById("fileContents").innerHTML = "error reading file";
			    }
			} else if (file) {
				alert("Wrong file type: "+file.name);
			} else {
				alert("Select a file first");
			};			
		};

</script>
<script type="text/javascript">	 
	// Global variables
	var ExperimentAcronym = "test";
	var ShuffleStimuli = true;
	var RandomizeAB = false;
	var audioBaseURL = './Stimuli/';
	var PracticeItems = 4;
	var NumberOfScales = 0;
	var NextText = "Next";
	var NextAlertText = "Please, listen to the recordings and answer the questions first";
	var ReadyText = "Ready";
	var PlayText = "Play";
	var RestartPageText = "Restart";
	var SaveButtonText = "Save Results";
	var SaveText = "Please, click XXSaveButtonTextXX and store the file";
	var ToolTipPlay = "Play sound";
	var ToolTipNext = "Go to next item";
	var ToolTipReady = "Ready, please save results";
	var ToolTipRestart = "Start a new experiment session";
	var ToolTipSave = "Save the answer to a file";
	var bodyStyleText = "";
	var addDigestText = "false";

	var stimulusTableJSON = '[["A","B","X"], ["beep.wav", "beep.wav", "beep.wav"]]';
	var requiredNames = [];
	var questionDefaults='"Default"';
	var audioNames = [];
	var textNames = [];
	var markdownStack = [];
	var currentMarkdown = "";
	var editPosition = 1;
	function initializeMarkdown() {
		if(navigator.userAgent.match(/Android/i)){
			document.getElementById('markdownText').style = 'font-family: Arial, Helvetica, sans-serif;';
			document.getElementById('markdownText').cols = 70;
			document.getElementById('htmlText').cols = 60;
		} else {
			document.getElementById('markdownText').style = 'font-family: "Lucida Console", "Courier New", monospace;';
			document.getElementById('markdownText').cols = 80;
			document.getElementById('htmlText').cols = 80;
		};
		document.getElementById('markdownText').value = initialMarkdown;
		currentMarkdown = initialMarkdown;
		markdownStack = [];
		markdownStack.push(currentMarkdown);
		markdown2HTML()
		
		document.getElementById('ShuffleStimuliYes').checked = ShuffleStimuli;
		document.getElementById('ShuffleStimuliNo').checked = !ShuffleStimuli;
		document.getElementById('RandomizeABYes').checked = RandomizeAB;
		document.getElementById('RandomizeABNo').checked = !RandomizeAB;
		document.getElementById('PracticeItems').value = PracticeItems;

		markdown2Parameters();
		parameters2Markdown();

		setHTMLdisplayButtonColor ();
		document.getElementById('ShowButton').style.backgroundColor = "red";
	};
	
	function flagButtons () {
		document.getElementById('RenderButtonDisplay').style.backgroundColor = "red";
		document.getElementById('RenderButtonText').style.backgroundColor = "red";
		document.getElementById('ShowButton').style.backgroundColor = "red";
		
		// Markdown changed, warn to save
		document.getElementById('SaveMDbutton').style.backgroundColor = "pink";
	};
	
	function unflagButtons () {
		setHTMLdisplayButtonColor ();
		document.getElementById('ShowButton').style.backgroundColor = "white";
	};
	
	function markdownPush() {
		// Do nothing if text is the same
		if(document.getElementById('markdownText').value == markdownStack[markdownStack.length -1])return 1;
		
		// Remove the stack above the editPosition
		if(editPosition > 1){
			markdownStack.length = markdownStack.length - editPosition + 1;
			editPosition = 1;
		};
		// Keep length of previous/next in check
		if(markdownStack.length  > 20) markdownStack.shift();
		markdownStack.push(document.getElementById('markdownText').value);
		currentMarkdown = document.getElementById('markdownText').value;
		
		// Read the parameters
		markdown2Parameters ();
	};
	
	function markdownUndo() {
		if(editPosition < (markdownStack.length)) editPosition += 1;
		current = markdownStack[markdownStack.length - editPosition];
		currentMarkdown = current;
		
		flagButtons ();
		
		return current;
	};
	function markdownCurrent() {
		editPosition = 1;
		current = markdownStack[markdownStack.length - editPosition];
		currentMarkdown = current;
		
		unflagButtons ();
		
		return current;
	};
	function markdownRedo() {
		if(editPosition < 2)editPosition = 2;
		editPosition -= 1;
		current = markdownStack[markdownStack.length - editPosition];
		currentMarkdown = current;
		
		flagButtons ();
		
		return current;
	};
	
	function encodeDirtyChar(dirty) {
		return '&#'+dirty.charCodeAt(0)+';';
	};
	
	function recodeDirtyChar(asciiNum) {
		return String.fromCharCode(asciiNum.replace(/\&\#(\d+)\;/, "$1"));
	};
	
	function cleanString (dirtyString) {
		if(typeof dirtyString != "string") return dirtyString;
		cleanedString = dirtyString.replace(/[|$%@"'<>\\()+`]/g, "");
		cleanedString = cleanedString.replace(/[,&;]/g, encodeDirtyChar);
		return cleanedString;
	};

	function restoreString (cleanString) {
		if(typeof cleanString != "string") return cleanString;
		restoredString = cleanString.replace(/\&\#(44|38|59)\;/g, recodeDirtyChar);
		return restoredString;
	};
	
	function parameters2Markdown() {
		currentMarkdown = document.getElementById('markdownText').value;
		var newLines = [];
		var parameterLines = [
			['[//comment]: # "These are internal parameters for the experiment and visible texts not in this Markdown"'],
			['[//comment]: # "----------"'],
			['[//parameter]: # "ExperimentAcronym:'+cleanString(ExperimentAcronym)+'"'],
			['[//parameter]: # "audioBaseURL:'+ audioBaseURL.replace(/[<>'"`]/g, '') +'"'],
			['[//parameter]: # "PracticeItems:'+cleanString(PracticeItems)+'"'],
			['[//parameter]: # "ShuffleStimuli:'+cleanString(ShuffleStimuli)+'"'],
			['[//parameter]: # "RandomizeAB:'+cleanString(RandomizeAB)+'"'],
			['[//comment]: # "CSS style for HTML body of page"'],
			['[//parameter]: # "body.style:'+bodyStyleText.replace(/"`/g, "")+'"'],
			['[//comment]: # "Add error checking digest to results"'],
			['[//parameter]: # "addDigest:'+addDigestText.replace(/"`/g, "")+'"'],
			['[//buttontext]: # "NextText:'+cleanString(NextText)+'"'],
			['[//buttontext]: # "NextAlertText:'+cleanString(NextAlertText)+'"'],
			['[//buttontext]: # "ReadyText:'+cleanString(ReadyText)+'"'],
			['[//buttontext]: # "PlayText:'+cleanString(PlayText)+'"'],
			['[//buttontext]: # "RestartPageText:'+cleanString(RestartPageText)+'"'],
			['[//buttontext]: # "SaveButtonText:'+cleanString(SaveButtonText)+'"'],
			['[//buttontext]: # "SaveText:'+cleanString(SaveText)+'"'],
			['[//tooltiptext]: # "ToolTipPlay:'+cleanString(ToolTipPlay)+'"'],
			['[//tooltiptext]: # "ToolTipNext:'+cleanString(ToolTipNext)+'"'],
			['[//tooltiptext]: # "ToolTipReady:'+cleanString(ToolTipReady)+'"'],
			['[//tooltiptext]: # "ToolTipRestart:'+cleanString(ToolTipRestart)+'"'],
			['[//tooltiptext]: # "ToolTipSave:'+cleanString(ToolTipSave)+'"'],
			['[//comment]: # "----------"']
		];
		var stimulusTableLines = [];
		stimulusTableLines.push(['[//comment]: # "These are stimuli for this experiment"']);
		stimulusTableLines.push(['[//comment]: # "----------"']);

		stimulusTableLines.push(['[//stimulus0]: # "' + stimulusTable[0] + '"']);
		for(var i=0;i < stimulusTable[1].length;++i){
			// Convert comma , to &#44;, " to &#34;, ' to &#39;
			var currentRow = stimulusTable[1][i];
			currentRow = currentRow.map(x => x.replace(/,/g, "&#44;").replace(/"/g, "&#34;").replace(/'/g, "&#39;"));
			// Convert to CSV text string
			stimulusTableLines.push(['[//stimulus1]: # "' + currentRow.join(",") + '"']);
		};
		stimulusTableLines.push(['[//comment]: # "----------"']);

		 currentMarkdown = currentMarkdown.replace(/\s*\n+$/, "");
		var lines = currentMarkdown.split(/\r?\n|\r|\n/g);
		for(var i=0; i < lines.length; ++i){
			if(lines[i].match(/\[\/\/(parameter|buttontext|tooltiptext|stimulus[01])\]: # ["']/) || 
				lines[i].match(/\[\/\/comment\]: # ["']These are internal parameters for the experiment and visible texts not in this Markdown["']/) || 
				lines[i].match(/\[\/\/comment\]: # ["']These are stimuli for this experiment["']/) || 
				lines[i].match(/\[\/\/comment\]: # ["']----------["']/)){
				// Do nothing
			} else {
				newLines.push(lines[i]);
			};
		};
		
		// Add parameters to the end
		for(var i=0;i < parameterLines.length;++i){
			newLines.push(parameterLines[i]);
		};
		
		// Add stimuli to the end
		for(var i=0;i < stimulusTableLines.length;++i){
			newLines.push(stimulusTableLines[i]);
		};
		
		currentMarkdown = newLines.join("\n");
		document.getElementById('markdownText').value = currentMarkdown;
	};
	
	function markdown2Parameters () {
		currentMarkdown = document.getElementById('markdownText').value ;
		var tmpStimulusTable0 = [];
		var tmpStimulusTable1 = [];
		var lines = currentMarkdown.split(/(\r|\n)/g);
		for(var i=0; i < lines.length; ++i){
			if(lines[i].match(/\[\/\/stimulus[01]\]: # ["']/)){
				var valueString = lines[i].replace(/^\s*\[\/\/stimulus[01]\]: # ["']/, "")
				valueString = valueString.replace(/['"]\s*$/, "");
				var valueList = valueString.split(/\s*,\s*/);
				// Restore &#44; to comma's, &#34; to ", &#39; to '
				valueList = valueList.map(x => x.replace(/\&\#44\;/g, ",").replace(/\&\#34\;/g, '"').replace(/\&\#39\;/g, "'"));
				if(lines[i].match(/\[\/\/stimulus0\]: # ["']/)){
					tmpStimulusTable0 = valueList;
				} else {
						tmpStimulusTable1.push(valueList);
				};
			};

			if(lines[i].match(/\[\/\/(parameter|buttontext|tooltiptext)\]: # ["']/)){
				parameterName = lines[i].replace(/^[^#]+# ["']([^"':]+)\s*:\s*([^"']+)["'].*$/, '$1');
				parameterValue = lines[i].replace(/^[^#]+# ["']([^"':]+)\s*:\s*([^"']+)["'].*$/, '$2');
				parameterValue = restoreString(parameterValue);
				switch(parameterName) {
						case "ExperimentAcronym":
							ExperimentAcronym = parameterValue;
							break;
						case "audioBaseURL":
							audioBaseURL = parameterValue;
							break;
						case "PracticeItems":
							PracticeItems = parameterValue;
							break;
						case "ShuffleStimuli":
								ShuffleStimuli = false;
								if(parameterValue == "true"){
									ShuffleStimuli = true;
								};
							break;
						case "RandomizeAB":
								RandomizeAB = false;
								if(parameterValue == "true"){
									RandomizeAB = true;
								};
								parameterValue = true;
							break;
						case "body.style":
								bodyStyleText = parameterValue;
								break
						case "addDigest":
								addDigestText = parameterValue;
							break;
						case "NextText":
							NextText = parameterValue;
							break;
						case "NextAlertText":
							NextAlertText = parameterValue;
							break;
						case "ReadyText":
							ReadyText = parameterValue;
							break;
						case "PlayText":
							PlayText = parameterValue;
							break;
						case "RestartPageText":
							RestartPageText = parameterValue;
							break;
						case "SaveButtonText":
							SaveButtonText = parameterValue;
							break;
						case "SaveText":
							SaveText = parameterValue;
							break;
						case "ToolTipPlay":
							ToolTipPlay = parameterValue;
							break;
						case "ToolTipNext":
							ToolTipNext = parameterValue;
							break;
						case "ToolTipReady":
							ToolTipReady = parameterValue;
							break;
						case "ToolTipRestart":
							ToolTipRestart = parameterValue;
							break;
						case "ToolTipSave":
							ToolTipSave = parameterValue;
							break;
						 default:
							break;
					} 
			};
		};
		
		// Construct stimulusTable
		if(tmpStimulusTable1.length > 0) stimulusTable = [tmpStimulusTable0, tmpStimulusTable1];

		stimulusTableJSON = "\` \n" + JSON.stringify(stimulusTable) + "\n\`"
		stimulusTableJSON = stimulusTableJSON.replace(/\],\[/g, "],\n[");
			
		document.getElementById('ExperimentAcronym').value = ExperimentAcronym;
		document.getElementById('audioBaseURL').value = audioBaseURL;
		document.getElementById('ShuffleStimuliYes').checked = ShuffleStimuli;
		document.getElementById('ShuffleStimuliNo').checked = !ShuffleStimuli;
		document.getElementById('RandomizeABYes').checked = RandomizeAB;
		document.getElementById('RandomizeABNo').checked = !RandomizeAB;
		document.getElementById('PracticeItems').value = PracticeItems;
		
		document.getElementById('PlayTextButton').value = PlayText;
		document.getElementById('PlayTextButton').title = ToolTipPlay;
		document.getElementById('PlayText').value = PlayText;
		document.getElementById('ToolTipPlay').value = ToolTipPlay;
		
		document.getElementById('NextTextButton').value = NextText;
		document.getElementById('NextTextButton').title = ToolTipNext;
		document.getElementById('NextText').value = NextText;
		document.getElementById('ToolTipNext').value = ToolTipNext;
		document.getElementById('NextAlertText').value = NextAlertText;
		
		document.getElementById('ReadyTextButton').value = ReadyText;
		document.getElementById('ReadyTextButton').title = ToolTipReady;
		document.getElementById('ReadyText').value = ReadyText;
		document.getElementById('ToolTipReady').value = ToolTipReady;
		
		document.getElementById('RestartPageTextButton').value = RestartPageText;
		document.getElementById('RestartPageTextButton').title = ToolTipRestart;
		document.getElementById('RestartPageText').value = RestartPageText;
		document.getElementById('ToolTipRestart').value = ToolTipRestart;
		
		document.getElementById('SaveButtonTextButton').value = SaveButtonText;
		document.getElementById('SaveButtonTextButton').title = ToolTipSave;
		document.getElementById('SaveButtonText').value = SaveButtonText;
		document.getElementById('ToolTipSave').value = ToolTipSave;
		
		document.getElementById('SaveText').value = SaveText;
	};
	
	function onlyUnique(value, index, array) {
			return array.indexOf(value) === index;
		}
		
	var winURL = '';
	function HTML2URL (pageHTML) {
		if(winURL.length > 0){
			URL.revokeObjectURL(winURL);
			winURL = '';
		};
		winURL = URL.createObjectURL(new Blob([pageHTML], { type: "text/html" }));
		return winURL;
	};
	
	var bodyFontSize=100;
	function incrementBodyFontSize () {
		bodyFontSize += 10;
		 markdown2HTML ();
		 document.getElementById("bodyFontSize").innerText = bodyFontSize + '%';
	};
	
	function decrementBodyFontSize () {
		if(bodyFontSize > 10){
			bodyFontSize -= 10;
		};
		markdown2HTML ();
		document.getElementById("bodyFontSize").innerText =  bodyFontSize + '%';
	};

	var displayWidthPerc=130;
	var markdownTextWidth = 80;
	function incrementDisplayWidth () {
		displayWidthPerc += 10;
		markdownTextWidth += 5;
		
		document.getElementById("markdownText").cols = markdownTextWidth;
		document.getElementById("htmlDisplay").width = displayWidthPerc + '%';
		document.getElementById("displayWidthText").innerText =  displayWidthPerc + '%';
	};
	
	function decrementDisplayWidth () {
		if(displayWidthPerc > 10){
			displayWidthPerc -= 10;
		};
		if(markdownTextWidth > 20){
			 markdownTextWidth -= 5;
		};
		
		document.getElementById("markdownText").cols = markdownTextWidth;
		document.getElementById("htmlDisplay").width =  displayWidthPerc + '%';
		document.getElementById("displayWidthText").innerText =  displayWidthPerc + '%';
	};
	
	function createDisplayHTMLpage (text) {
		
		var fullPage = '<!DOCTYPE html><head>\n'+experimentStyles + '\n\<script  type="text/javascript"\>\n' + `
			function stopAllAudio () {
				var audioPlayers = document.getElementsByTagName('Audio');
				for(i in audioPlayers){
					if(typeof audioPlayers[i] == 'object'){
						audioPlayers[i].pause();
						audioPlayers[i].currentTime = 0;
					};
				};
			};
		` + '\n\</script\>' +'\n<body style="' + 'font-size: ' + bodyFontSize + '%;' + bodyStyleText + '">\n'+text+'\n</body>';
		
		return fullPage;
	};
	
	function markdown2HTML () {
		// Warn if markdown-it has not been loaded
		if(typeof window.markdownit == 'undefined') {
			document.getElementById('htmlText').value = `
			HTML not available
			"markdown-it.min.js" not found
			try:
			https://www.jsdelivr.com/package/npm/markdown-it
			https://cdnjs.com/libraries/markdown-it
			`
			// Display in HTML text
			document.getElementById('htmlText').style.display = 'block';
			document.getElementById('htmlDisplay').style.display = 'none';
			document.getElementById('bodyFontLine').style.visibility = 'hidden';

			return null;
		};
		
		currentMarkdown = document.getElementById('markdownText').value ;
		var processedMarkdown = preProcessMD (currentMarkdown);
		var htmlText = window.markdownit({
			  html: true
		}).render(processedMarkdown);
		HTMLchanged = false;

		var newPage = createDisplayHTMLpage (htmlText);
		if(SwitchedPage > 0){
			newPage = setExperimentPageHTMLtext (newPage);
		};
		setSwitchPageButtonColor (newPage)

		document.getElementById('htmlText').value = newPage;
		winURL = HTML2URL (newPage);
		document.getElementById('htmlDisplay').src=winURL;
		
		// Set up the couter of for the unblock function
		requiredNames = document.getElementById('htmlText').value.match(/name\s*\=\s*['"](Audio|Question)[^'"]*['"]/ig);
		requiredNames = requiredNames.map(x => x.replace(/name\s*\=\s*['"]([^'"]*)['"]/, "$1"));
		requiredNames = requiredNames.filter(onlyUnique);
		
		// Set buttons
		setHTMLdisplayButtonColor ();
		document.getElementById('ShowButton').style.backgroundColor = "red";
		
		return document.getElementById('htmlText').value ;
	}
	
	function markdown2HTMLdisplay () {
		markdown2HTML();
		
		// Display in iFrame
		document.getElementById('htmlText').style.display = 'none';
		document.getElementById('htmlDisplay').style.display = 'block';
		document.getElementById('bodyFontLine').style.visibility = 'visible';
	
		setHTMLdisplayButtonColor ();
	}
	
	function markdown2HTMLtext () {
		markdown2HTML();
		
		// Display in HTML text
		document.getElementById('htmlText').style.display = 'block';
		document.getElementById('htmlDisplay').style.display = 'none';
		document.getElementById('bodyFontLine').style.visibility = 'hidden';
		
		setHTMLdisplayButtonColor ();
	}

	// Switch HTML Display/Text
	function setHTMLdisplayButtonColor () {
		var currentSwitchColor = 'white';
		if(HTMLchanged) {
			document.getElementById('RenderButtonDisplay').style.backgroundColor = 'red';
			document.getElementById('RenderButtonText').style.backgroundColor = 'red';			
		} else if(document.getElementById('htmlText').style.display == 'block') {
			document.getElementById('RenderButtonDisplay').style.backgroundColor = 'white';
			document.getElementById('RenderButtonText').style.backgroundColor = 'gray';
		} else if (document.getElementById('htmlDisplay').style.display == 'block') {
			document.getElementById('RenderButtonDisplay').style.backgroundColor = 'gray';
			document.getElementById('RenderButtonText').style.backgroundColor = 'white';
		};
	};
	
	// Switch Cover/Experiment Page button
	var SwitchedPage = 0;
	function setSwitchPageButtonColor (text) {
		var currentSwitchColor = 'gray';
		if(text.match(/<div id="coverpage" style="[^"]*display:\s*block[^"]*">/i)) {
			currentSwitchColor = 'MediumAquaMarine';
			SwitchedPage = -1;
		} else if (text.match(/<div id="coverpage" style="[^"]*display:\s*none[^"]*">/i)) {
			currentSwitchColor = 'CornflowerBlue';
			SwitchedPage = 1;
		};
		document.getElementById('SwitchPageDisplay').style.backgroundColor = currentSwitchColor;
	};
	
	function switchPageHTMLdisplay () {
			var currentHTML = document.getElementById('htmlText').value;
			if(currentHTML.match(/<div id="coverpage" style="[^"]*">/i)){
				if(currentHTML.match(/<div id="coverpage" style="[^"]*display:\s*block[^"]*">/i)) {
						currentHTML = setExperimentPageHTMLtext (currentHTML);
				} else {
						currentHTML = setCoverPageHTMLtext (currentHTML);
				};
				
				setSwitchPageButtonColor (currentHTML);
				
				document.getElementById('htmlText').value = currentHTML;
				winURL = HTML2URL (currentHTML);
				document.getElementById('htmlDisplay').src=winURL;
			} ;
	};
	
	// If there is a cover page, set the HTML to display it
	function setCoverPageHTMLtext (text) {
		// coverpage = block
		 text = text.replace(/<div id="coverpage" style="([^"]*display:\s*)none([^"]*)">/ig, "<div id=\"coverpage\" style=\"$1block$2\">");
		 // experimentpage = none
		 text = text.replace(/<div id="experimentpage" style="([^"]*display:\s*)block([^"]*)">/ig, "<div id=\"experimentpage\" style=\"$1none$2\">");
		 
		 return text;
	};
	
	// If there is an experiment  page, set the HTML to display it
	function setExperimentPageHTMLtext (text) {
		// coverpage = none
		 text = text.replace(/<div id="coverpage" style="([^"]*display:\s*)block([^"]*)">/ig, "<div id=\"coverpage\" style=\"$1none$2\">");
		 // experimentpage = block
		 text = text.replace(/<div id="experimentpage" style="([^"]*display:\s*)none([^"]*)">/ig, "<div id=\"experimentpage\" style=\"$1block$2\">");
		 
		 return text;
	};
	
	function unswitchedPageHTMLtext (text) {
		if(text.match(/<div id="coverpage"/i)) {
		   text = setCoverPageHTMLtext (text);
		};
		setSwitchPageButtonColor (text);
		
		return text;
	};
	
	var HTMLchanged = false;
	function openAndWrite(preamble, text, postamble) {
		if(!HTMLchanged){
			markdown2HTML();
			text =  document.getElementById('htmlText').value;
		};
		
		// Make sure the real page start on the cover page
		text =   unswitchedPageHTMLtext(text);
		
		// Wipe localstorage
		localStorage.removeItem(ExperimentAcronym+'stimuluslist');
		localStorage.removeItem(ExperimentAcronym+'columnnames');
		localStorage.removeItem(ExperimentAcronym+'answerlist');
		
		// Finish HTML and open page
		var preambleProc = preProcessPreamble(preamble);
		var postambleProc = preProcessPreamble(postamble);
		const pageHTML = preambleProc + text + postambleProc;
		winUrl = HTML2URL (pageHTML);
		const win = window.open(
			winUrl,
			"RenderedHTML",
			"popup"
			);
		if(HTMLchanged){
			document.getElementById('ShowButton').style.backgroundColor = "pink";
		} else {
			document.getElementById('ShowButton').style.backgroundColor = "white";
		};
		setHTMLdisplayButtonColor ();

		document.getElementById('saveHTMLbutton').style.backgroundColor = "red";
	}
	
	function saveMarkdown() {
			var mdBlob = new Blob([document.getElementById('markdownText').value], {type: 'text/plain'});
			var mdBlobUrl = URL.createObjectURL(mdBlob);
			const anchor = document.createElement('a');
			anchor.href = mdBlobUrl;
			anchor.target = "_blank";
			anchor.download = ExperimentAcronym+"_experiment.md";

			 // Auto click on a element, trigger the file download
			 anchor.click();

			 // This is required
			 URL.revokeObjectURL(mdBlobUrl);
			 
			 // Unflag Save button
			 document.getElementById('SaveMDbutton').style.backgroundColor = "white";
		};
	
	function saveHTML() {
			// Update HTML id HTML has not been edited
			if(!HTMLchanged){
				markdown2HTML();
			};
			var preambleProc = preProcessPreamble(preamble);
			var postambleProc = preProcessPreamble(postamble);
			const pageHTML = preambleProc + document.getElementById('htmlText').value + postambleProc;
			var htmlBlob = new Blob([pageHTML], { type: "text/html" });
			var htmlBlobUrl = URL.createObjectURL(htmlBlob);
			const anchor = document.createElement('a');
			anchor.href = htmlBlobUrl;
			anchor.target = "_blank";
			anchor.download = ExperimentAcronym+"_experiment.html";

			 // Auto click on a element, trigger the file download
			 anchor.click();

			 // This is required
			 URL.revokeObjectURL(htmlBlobUrl);
			 
			 document.getElementById('saveHTMLbutton').style.backgroundColor = "white";
			 document.getElementById('ShowButton').style.backgroundColor = "white";
		};
	
	function saveStimulusTableJSON() {
			var stimBlob = new Blob(["var stimulusTableJSON = "+stimulusTableJSON+";"], {type: 'text/plain'});
			var stimBlobUrl = URL.createObjectURL(stimBlob);
			const anchor = document.createElement('a');
			anchor.href = stimBlobUrl;
			anchor.target = "_blank";
			anchor.download = ExperimentAcronym+"_stimuluslist.js";

			 // Auto click on a element, trigger the file download
			 anchor.click();

			 // This is required
			 URL.revokeObjectURL(stimBlobUrl);
		};
	
	var buttonCounter = 0;
	function brackets2radiobuttons (text, offset, string) {
		buttonCounter += 1;
		result = '<input type="radio" value="'+buttonCounter+'" name="QuestionXXXX" id="QuestionXXXX.'+ buttonCounter +'" onchange="unblockNext(\'QuestionXXXX\')" oninput="answer[XXXX - 1]=this.value">';
		
		return result;
	};
	
	function replaceCoverPage (text) {
		if(text.match(/(^|\n)\s*\[\/\/\s*coverpage\s*\]\:\s+\#\s+\"[^\"]+\"/i)) {
			text = text.replace(/(^|\n)\s*\[\/\/\s*coverpage\s*\]\:\s+\#\s+\"\s*Start of coverpage\s*\"/ig, '\n<div id="coverpage" style="display: block">');
			text = text.replace(/\n[ \t]*\[\/\/\s*coverpage\s*\]\:\s+\#\s+\"\s*End of coverpage\s*\"/ig, '\n</div>\n<div id="experimentpage" style="display: none">\n');
			text += '\n</div>\n';
			
		};
		return text;
	};

	function replaceRadioButons (text) {
		return text.replace(/\(\(\)\)/g, brackets2radiobuttons)
	};
	
	function replaceVASslider (text) {
		return text.replace(/\>\>[-]{10,}\<\</g,	'<input type="range" min="1" max="1000" value="500" class="slider" id="QuestionXXXX" name="QuestionXXXX" onchange="unblockNext(\'QuestionXXXX\')" oninput="answer[XXXX - 1]=this.value" style="width:100%;">')
	};
	
	// Input text field <<| default text { css style }|>>
	function replaceTextInput (text) {
		return text.replace(/\<\<\\?[\|\¦]\s*([^\|\¦\{\\]*[^\|\¦\{\s\\])\s*(\{\s*([^\}\\]*[^\}\\\s])\s*\})?\s*\\?[\|\¦]\>\>/g,	'<input type="text" value="$1" title="$1" id="QuestionXXXX" name="QuestionXXXX" onfocus="if(`$1`==this.value)this.value=``" onchange="unblockNext(\'QuestionXXXX\')" oninput="answer[XXXX - 1]=this.value" style="$3">')
	};
	
	// Text insertions
	function replaceTextItems (text) {
		// Fixed text field (iframe) {{{< url >|  css style }}}
		// First, remove the fixed, iFrame cases
		text = text.replace(/\{\{\{\<([^\>\|\¦\\]*[^\>\|\¦\\\s])\s*\>(\s*\\?[\|\¦]([^\}]*))?\}\}\}/g, '<iframe id="FixedText$1" src="$1"   scrolling="auto" name="FixedText" style="$3"></iframe>');;

		// Parameter fields {{{! parameter ! | css style }}}
		text = text.replace(/\{\{\{!\s*([^\|!\¦]*[^\|!\¦\s])\s*!(\s*\\?[\|\¦]([^\}]*))?\}\}\}/g, '<span id="$1" name="parameterText" style="$3"></span>');

		// StimulusTable references {{{ stimulus | css style }}}
		var textNamesRaw = text.match(/\{\{\{([^\}]+)\}\}\}/g);
		if(textNamesRaw != null && textNamesRaw.length > 0) {
			// Seperate text names from text
			textNamesRaw = textNamesRaw.map(x => x.replace(/^\{+\s*([^\}\|\¦\\]*[^\}\|\¦\\\s])(\s*\\?[\|\¦]([^\}]*))?\s*\}+$/g, "$1"))
			textNames.push(textNamesRaw);

			textNames = textNames.flat();
			text = text.replace(/\{\{\{\s*([^\}\|\¦\\]*[^\}\|\¦\\\s])(\s*\\?[\|\¦]\s*([^\}]*))?\s*\}\}\}/g, '<span id="Text$1" name="Text$1" style="$3"></span>');
		};
	
		return text;	
	};
	
	// Audio buttons [[[ label | stimulus {css style} ]]]
	function replaceAudio (text) {
		var audioNamesRaw = text.match(/\[\[\[([^\]]+)\]\]\]/g);
		
		// Remove direct audio links
		audioNamesRaw = audioNamesRaw.filter(function(x){return !x.match(/[\>\<]/)})
		// Seperate audio names from text
		audioNamesRaw = audioNamesRaw.map(x => x.replace(/^\[+\s*([^\|\¦\{]*[\|\¦])?\s*([^\]\{]*[^\]\{\s])\s*(\{.*)?\]+$/g, "$2"))
		audioNames.push(audioNamesRaw);

		audioNames = audioNames.flat();

		// Fixed links [[[ label | <url> {css style}]]]
		text = text.replace(/\[\[\[\s*([^\]\|\¦\\]*[^\]\|\¦\\\s])\s*\\?[\|\¦]\s*\<([^\>]*)\>\s*(\{\s*([^\}]+)\s*\})?\]\]\]/g, '<audio id="Fixed$2" name="Fixed$2" src="$2" preload="auto" title="" ></audio><button onclick="stopAllAudio ();document.getElementById(\'Fixed$2\').play();" style="font-size:30px;background-color:white;$4;"><strong><div id="PlayFixed$2Text" style="background-color:white;">$1</div></strong></button>');
				
		// Stimulus links with label [[[ label | stimulus {css style}]]]
		text = text.replace(/\[\[\[\s*([^\]\|\¦\\]*[^\]\|\¦\\\s])\s*\\?[\|\¦]\s*([^\]\{]*[^\]\{\s])\s*(\{\s*([^\}]*[^\}\s])\s*\})?\s*\]\]\]/g, '<audio id="Audio$2" name="Audio$2" src="" preload="auto" title="" onplaying="unblockNext (\'Audio$2\');"></audio><a href="javascript:void(0)" id="ToolTipAudio$2" data-toggle="tooltip" title="'+ToolTipPlay+'"><button onclick="stopAllAudio ();document.getElementById(\'Audio$2\').play();" style="font-size:30px;background-color:white;$4;"><strong><div id="PlayAudio$2Text" style="background-color:white;">'+PlayText+' $1</div></strong></button></a>');
		
		// Stimulus links without label [[[ stimulus {css style}]]]
		return text.replace(/\[\[\[\s*([^\]\{]*[^\]\{\s])\s*(\{\s*([^\}]*[^\}\s])\s*\})?\s*\]\]\]/g, '<audio id="Audio$1" name="Audio$1" src="" preload="auto" title="" onplaying="unblockNext (\'Audio$1\');"></audio><a href="javascript:void(0)" id="ToolTipAudio$1" data-toggle="tooltip" title="'+ToolTipPlay+'"><button onclick="stopAllAudio ();document.getElementById(\'Audio$1\').play();" style="font-size:30px;background-color:white;$3;"><strong><div id="PlayAudio$1Text" style="background-color:white;">'+PlayText+' $1</div></strong></button></a>');
	};

	function preProcessMD (text) {
		var lines = text.split(/\r?\n|\r|\n/g);
		var questionNum = 0;
		audioNames = [];
		textNames = [];
		for(var i=0; i < lines.length; ++i){
			// Stimuli
			if(lines[i].match(/\[\[\[[^\]]*\]\]\]/)){
				lines[i] = replaceAudio(lines[i]);
			};

			if(lines[i].match(/\{\{\{[^\}]*\}\}\}/)){
				lines[i] = replaceTextItems(lines[i]);
			};
			
			// Input
			buttonCounter = 0;
			if(lines[i].match(/\(\(\)\)/)){
				++questionNum;
				lines[i] = replaceRadioButons (lines[i]);
				lines[i] = lines[i].replace(/XXXX/g, questionNum);
			};
			if(lines[i].match(/\>\>[-]{10,}\<\</)){
				++questionNum;
				lines[i] = replaceVASslider (lines[i]);
				lines[i] = lines[i].replace(/XXXX/g, questionNum);
			};
			if(lines[i].match(/\<\<[\|\¦]|[\|\¦]\>\>/)){
				++questionNum;
				lines[i] = replaceTextInput (lines[i]);
				lines[i] = lines[i].replace(/XXXX/g, questionNum);
			};
			
		}; 
		// Ready number of scales
		NumberOfScales = questionNum;
		var processedText = lines.join('\n');
		
		// insert Cover page
		processedText = replaceCoverPage(processedText);
		
		return processedText;
	};
	
	function preProcessPreamble (text) {
			var processedPreamble = text.replace(/XXNUMBEROFSCALESXX/g, NumberOfScales);
			processedPreamble = processedPreamble.replace(/XXEXPERIMENTNAMEXX/g, ExperimentAcronym);
			processedPreamble = processedPreamble.replace(/XXRANDOMIZEABXX/g, RandomizeAB);
			processedPreamble = processedPreamble.replace(/XXSHUFFLESTIMULUSLISTXX/g, ShuffleStimuli);
			processedPreamble = processedPreamble.replace(/XXaudioBaseURLXX/g, audioBaseURL);
			processedPreamble = processedPreamble.replace(/XXPracticeItemsXX/g, PracticeItems);
			processedPreamble = processedPreamble.replace(/XXNextTextXX/g, NextText);
			processedPreamble = processedPreamble.replace(/XXNextAlertTextXX/g, NextAlertText);
			processedPreamble = processedPreamble.replace(/XXReadyTextXX/g, ReadyText);
			processedPreamble = processedPreamble.replace(/XXPlayTextXX/g, PlayText);
			processedPreamble = processedPreamble.replace(/XXRestartPageTextXX/g, RestartPageText);
			processedPreamble = processedPreamble.replace(/XXSaveTextXX/g, SaveText);
			processedPreamble = processedPreamble.replace(/XXSaveButtonTextXX/g, SaveButtonText);
			processedPreamble = processedPreamble.replace(/XXToolTipNextXX/g, ToolTipNext);
			processedPreamble = processedPreamble.replace(/XXToolTipReadyXX/g, ToolTipReady);
			processedPreamble = processedPreamble.replace(/XXToolTipRestartXX/g, ToolTipRestart);
			processedPreamble = processedPreamble.replace(/XXToolTipSaveXX/g, ToolTipSave);
			processedPreamble = processedPreamble.replace(/XXstimulusTableJSONXX/g, stimulusTableJSON);
			
			processedPreamble = processedPreamble.replace(/var audioNames\s*\=\s*\[\];/, 'var audioNames = ["'+audioNames.join('", "')+'"];');
			processedPreamble = processedPreamble.replace(/var textNames\s*\=\s*\[\];/, 'var textNames = ["'+textNames.join('", "')+'"];');
			processedPreamble = processedPreamble.replace(/var requiredNames\s*\=\s*\[\];/, 'var requiredNames = ["'+requiredNames.join('", "')+'"];');
			processedPreamble = processedPreamble.replace(/var addDigest\s*=\s*false;/, 'var addDigest = '+addDigestText.replace(/["']/g, "") +';');
			processedPreamble = processedPreamble.replace(/<body onload="SetUp\(\);" style="">/, '<body onload="SetUp();" style="' + bodyStyleText.replace(/["]/g, "") + '">');
			
			return processedPreamble;
	};
	
	function setUp() {
		if(window.location.search.match(/ExperimentAcronym\=/)){
				fileName = window.location.search.replace(/^.*ExperimentAcronym\=([^&]+)[&]?.*$/g, "$1");
				if(fileName.length > 0){
					loadMarkdown('./'+fileName+'_markdown.js');
										
					// Clear body.style
					bodyStyleText = "";
				};
		};
		initializeMarkdown();
	};
	
</script>

</head>
<body onload="setUp()">

<h2>Create an experiment</h2>


<div style="width: 100%; overflow: hidden;">
	<div style="width: 50%; float: left;"> 
		<table style="width:80%">
			<tr><td>&nbsp;</td><td>&nbsp;</td></tr>
			<tr>
				<td>Select an acronym for <br/> the experiment (no spaces): </td><td><input type="text" id="ExperimentAcronym" name="ExperimentAcronym" value="name_without_spaces" title='This acronym will be used for the name of the experiment files' onfocus="if(this.value=='name_without_spaces')this.value='';" onchange="this.value=this.value.replace(/\s+/g, '_'); ExperimentAcronym=this.value; parameters2Markdown();" > </td>
			</tr>
			<tr>
				<td>Randomize stimuli: </td><td>Yes  <input type="radio" id="ShuffleStimuliYes" name="ShuffleStimuli" value="Yes" onchange="ShuffleStimuli=true;parameters2Markdown();"> No <input type="radio" id="ShuffleStimuliNo" name="ShuffleStimuli" value="No" onchange="ShuffleStimuli=false;parameters2Markdown();"> </td>
			</tr>
			<tr>
				<td>Number of practice items:  </td><td><input type="text" id="PracticeItems" name="PracticeItems" title='A positive value, n, copies the last n (randomized) stimuli of the list in reverse order to the front of the list. The list of stimuli will be n items longer. A negative, -n, value will use the first n values of the list in the unrandomized order given. The number of stimuli stays the same with a negative n.' value="" onchange="PracticeItems=this.value;parameters2Markdown();"> </td>
				</tr>
			<tr>
				<td>Randomize AB stimulus pairs:  </td><td>Yes <input type="radio" id="RandomizeABYes" name="RandomizeAB" value="Yes" onchange="RandomizeAB=true;parameters2Markdown();"> No <input type="radio" id="RandomizeABNo" name="RandomizeAB" value="No" onchange="RandomizeAB=false;parameters2Markdown();"> </td>
			</tr>
			<tr>
				<td>URL/path to audio:  </td><td><input type="text" id="audioBaseURL" name="audioBaseURL" value="./Stimuli/" title='This can be a URL or local path to a folder with audio' onchange="audioBaseURL=this.value; parameters2Markdown();" ></td>
			</tr>
			<tr>
			<td colspan=2> 
					<form action="javascript:readTableFromFile ('StimulusFileUpload'); void(0);" accept="text/plain">
					<label for="StimulusFileUpload" title='Create a stimulis file as a table with column headers in a spreadsheet and save it as a .csv file. Open it here to insert the stimuli into the experiment file. From here, you can download it as a JSON .js file to have a way to edit it later independently of the experiment HTML file.'>Open a Stimulus Table (.csv):</label>
					<input type="file" id="StimulusFileUpload" onchange="document.getElementById('csv-upload-button').style.backgroundColor='MediumAquaMarine'"> 
					<button id="csv-upload-button" onclick="this.style.backgroundColor='white'" title='Open the .csv stimulus table from the chosen file.'> Upload </button>
					</form>	
				</td>
			</tr>
			<tr>
				<td>Separator for stimulus table: </td>
				<td style='text-align:right;'>
						<select id="Separator" title='Select the separator used in the .csv stimulus table. This page cannot handle fancy use of ,-commas in a literal ,-comma separated values table.'>
						  <option value="automatic">automatic</option>
						  <option value="semicolon">semicolon</option>
						  <option value="tab">tab</option>
						  <option value="comma">comma</option>
						</select> 
					&emsp;&emsp;
						<input type="button" id='SaveStimulusTable' value="Download stimuli" title='Save a stimulus JSON .js file for automatic opening during experiments' onclick="saveStimulusTableJSON()" style='background-color:gray;visibility:hidden'></td>
				</td>
			</tr>
			<tr><td>&nbsp;</td><td>&nbsp;</td></tr>
			<tr>
			<td colspan=2><form action="javascript:readMDFromFile ('MarkdownFileUpload'); void(0);" accept="text/plain">
					<label for="MarkdownFileUpload">Open a Markdown file (.md):</label> <input type="file" id="MarkdownFileUpload" onchange="document.getElementById('md-upload-button').style.backgroundColor='MediumAquaMarine'"> 
					<button id="md-upload-button" onclick="this.style.backgroundColor='white'"> Upload </button>
				</form></td>
			</tr>
			<tr><td>&nbsp;</td><td>&nbsp;</td></tr>
		</table>
	</div>
	<div style="width: 50%; float: right;"> 
		<table style="width:80%">
		<tr  style='font-size:80%'><th>Fixed&nbsp;texts</th><th>Button</td><th>Text</th><th>Tooltip</th></tr>
		<tr>
			<td  style='font-size:80%'>Play&nbsp;text: </td>
			<td><input type="button" id="PlayTextButton" value=""  title="" style="background-color: MediumAquaMarine"></td>
			<td><input type="text" id="PlayText" name="PlayText" value='' onfocus="if(this.value==PlayText)this.value='';" onchange="PlayText=this.value;document.getElementById('PlayTextButton').value=this.value;parameters2Markdown();" size=15></td>
			<td><input type="text" id="ToolTipPlay" name="ToolTipPlay" value='' onchange="ToolTipPlay=this.value;document.getElementById('PlayTextButton').title=this.value;parameters2Markdown();" size=35></td>
		</tr>
		<tr>
			<td  style='font-size:80%'>Next&nbsp;text: </td>
			<td><input type="button" id="NextTextButton" value="" title="" style="background-color: MediumAquaMarine"> </td>
			<td><input type="text" id="NextText" name="NextText" value='' onfocus="if(this.value==NextText)this.value='';" onchange="NextText=this.value;document.getElementById('NextTextButton').value=this.value;parameters2Markdown();" size=15></td>
			<td><input type="text" id="ToolTipNext" name="ToolTipNext" value='' onchange="ToolTipNext=this.value;document.getElementById('NextTextButton').title=this.value;parameters2Markdown();" size=35></td>
		</tr>
		<tr>
			<td  style='font-size:80%'>Next&nbsp;page&nbsp;Alert: </td>
			<td></td>
			<td colspan="2"><input type="text" id="NextAlertText" name="NextText" value='' onfocus="if(this.value==NextText)this.value='';" onchange="NextAlertText=this.value;parameters2Markdown();" size=35></td>
		</tr>
		<tr>
			<td  style='font-size:80%'>Ready&nbsp;text: </td>
			<td><input type="button" id="ReadyTextButton" value="" title="" style="background-color: MediumAquaMarine"> </td>
			<td><input type="text" id="ReadyText" name="ReadyText" value='' onfocus="if(this.value==ReadyText)this.value='';" onchange="ReadyText=this.value;document.getElementById('ReadyTextButton').value=this.value;parameters2Markdown();" size=15></td>
			<td><input type="text" id="ToolTipReady" name="ToolTipReady" value='' onchange="ToolTipReady=this.value;document.getElementById('ReadyTextButton').title=this.value;parameters2Markdown();" size=35></td>
		</tr>
		<tr>
			<td  style='font-size:80%'>Restart&nbsp;text: </td>
			<td><input type="button" id="RestartPageTextButton" value=""  title="" style="background-color: MediumAquaMarine"></td>
			<td><input type="text" id="RestartPageText" name="RestartPageText" value='' onfocus="if(this.value==RestartPageText)this.value='';" onchange="RestartPageText=this.value;document.getElementById('RestartPageTextButton').value=this.value;parameters2Markdown();" size=15> </td>
			<td><input type="text" id="ToolTipRestart" name="ToolTipRestart" value='' onfocus="if(this.value==ToolTipRestart)this.value='';" onchange="ToolTipRestart=this.value;document.getElementById('NextTextButton').title=this.value;parameters2Markdown();" size=35></td>
		</tr>
		<tr>
			<td  style='font-size:80%'>Save&nbsp;button&nbsp;text: </td>
			<td><input type="button" id="SaveButtonTextButton" value=""  title="" style="background-color: MediumAquaMarine"> </td>
			<td><input type="text" id="SaveButtonText" name="SaveButtonText" value='' onfocus="if(this.value==SaveButtonText)this.value='';" onchange="SaveButtonText=this.value;document.getElementById('SaveButtonTextButton').value=this.value;parameters2Markdown();" size=15></td>
			<td><input type="text" id="ToolTipSave" name="ToolTipSave" value='' onchange="ToolTipSave=this.value;document.getElementById('NextTextButton').title=this.value;parameters2Markdown();" size=35></td>
		</tr>
		<tr>
			<td  style='font-size:80%'>Save&nbsp;text: </td><td>&nbsp;</td>
			<td colspan="2"><input type="textarea" rows=2 id="SaveText" name="SaveText" value='' onchange="SaveText=this.value;parameters2Markdown();" size=50></td>
		</tr>
		<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
		</table>
	</div>
</div>

<div style="width: 100%; overflow: hidden;">
	<div style="width: 50%; float: left;"> 
		<table>
			<tr style="width:80%">
			<td><input type="button" value="Reset" onclick="document.getElementById('markdownText').value = initialMarkdown;"</td>
			<td><input type="button" value="< Undo" onclick="document.getElementById('markdownText').value = markdownUndo();"</td>
			<td><input type="button" value="Current" onclick="document.getElementById('markdownText').value = markdownCurrent();"</td>
			<td><input type="button" value="Redo >" onclick="document.getElementById('markdownText').value = markdownRedo();"</td>
			<td><input type="button" value="Clear" onclick="document.getElementById('markdownText').value = ' ';"</td>
			<td  width="35%">&emsp;</td>
			<td><input type="button" id='SaveMDbutton' value="Save MD..." onclick="saveMarkdown() " title='Save current Markdown and settings as .md file. '</td>
			</tr>
		</table>

		<textarea id="markdownText" rows=50 cols=80 onfocusout="markdownPush();" onchange='markdown2HTML();' style='font-family: "Lucida Console", "Courier New", monospace;'>
		</textarea><br />
		<table width='100%'><tr><td  width="85%">&emsp;</td><td><span title='Zoom display widths'><a href='javascript:void(0)' onclick='decrementDisplayWidth ();' style='text-decoration-line: none;font-weight: bold;'> &larr;</a> <span id='displayWidthText'>127%</span> <a href='javascript:void(0)' onclick='incrementDisplayWidth ();' style='text-decoration-line: none;font-weight: bold;'>&rarr; </a></span></td></tr></table>
	</div>

	<div style="width: 50%; float: right;"> 
		<table>
			<tr style="width:80%">
			<td><input type="button" id='RenderButtonDisplay' value="Display HTML" onclick="markdown2HTMLdisplay ()"  title='The HTML displayed here is non-functional. Click the "Show Page" button to open a functional page'></td>
			<td><input type="button" id='SwitchPageDisplay' value="Switch Page" onclick="switchPageHTMLdisplay ()"  title='Switch between Cover Page and Experiment Page' style='background-color: gray;'></td>
			<td><input type="button" id='RenderButtonText' value="HTML text" onclick="markdown2HTMLtext ()"></td>
			<td><input type="button" id='ShowButton' value="Show Page" onclick="openAndWrite(preamble, document.getElementById('htmlText').value, postamble);"></td>
			<td  width="25%">&nbsp;<span id='bodyFontLine' style='display=none;' title='Zoom text'><a href='javascript:void(0)' onclick='incrementBodyFontSize ();' style='text-decoration-line: none;font-weight: bold;'> &uarr;</a> <span id='bodyFontSize'>100%</span> <a href='javascript:void(0)' onclick='decrementBodyFontSize ();' style='text-decoration-line: none;font-weight: bold;'>&darr; </a></span>&emsp;</td>
			<td><input type="button" id='saveHTMLbutton' value="Save Experiment..." onclick="saveHTML()" title='Save current experiment as an HTML web page'</td>
		</table>

	    <textarea id="htmlText" rows=60 cols=80' onchange="HTMLchanged = true; document.getElementById('ShowButton').style.backgroundColor = 'red';" style='display:none;'>
		</textarea>
		<div style='zoom: 0.75' title='The HTML displayed here is non-functional. Click the "Show Page" button to open a functional page'>
		<iframe src="" id='htmlDisplay' name='htmlDisplay'  scrolling="auto" width=127% height=1550 style='vertical-align: bottom; zoom: 0.75;-moz-transform: scale(0.75);  -moz-transform-origin: 0 0;  -o-transform: scale(0.75);  -o-transform-origin: 0 0;  -webkit-transform: scale(0.75);  -webkit-transform-origin: 0 0; display:block;' ></iframe>
	    </div>
	</div>
 </div>

</body>
